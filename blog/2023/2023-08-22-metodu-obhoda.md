---
title: Методы обхода блокировок "Великого китайского файрвола"
date: '2023-08-22 14:23:00'
---

# Методы обхода блокировок "Великого китайского файрвола" - IT Нинзя

> ## Excerpt
>
> Современные методы интернет-цензуры и методы её обхода, это бесконечная гонка вооружений, мне
> данная тема интересна в разрезе применяемых технологический решений, дизайне протоколов и связки
> всего этого в единое целое законченное решение, которое естественно устареет через короткий
> промежуток времени.

---

## Содержание

1.  [Теория](https://iamninja.ru/2023/08/16/%d0%bc%d0%b5%d1%82%d0%be%d0%b4%d1%8b-%d0%be%d0%b1%d1%85%d0%be%d0%b4%d0%b0-%d0%b1%d0%bb%d0%be%d0%ba%d0%b8%d1%80%d0%be%d0%b2%d0%be%d0%ba-%d0%b2%d0%b5%d0%bb%d0%b8%d0%ba%d0%be%d0%b3%d0%be-%d0%ba%d0%b8/#1)
2.  [Технологический стек](https://iamninja.ru/2023/08/16/%d0%bc%d0%b5%d1%82%d0%be%d0%b4%d1%8b-%d0%be%d0%b1%d1%85%d0%be%d0%b4%d0%b0-%d0%b1%d0%bb%d0%be%d0%ba%d0%b8%d1%80%d0%be%d0%b2%d0%be%d0%ba-%d0%b2%d0%b5%d0%bb%d0%b8%d0%ba%d0%be%d0%b3%d0%be-%d0%ba%d0%b8/#2)
3.  [Реализация](https://iamninja.ru/2023/08/16/%d0%bc%d0%b5%d1%82%d0%be%d0%b4%d1%8b-%d0%be%d0%b1%d1%85%d0%be%d0%b4%d0%b0-%d0%b1%d0%bb%d0%be%d0%ba%d0%b8%d1%80%d0%be%d0%b2%d0%be%d0%ba-%d0%b2%d0%b5%d0%bb%d0%b8%d0%ba%d0%be%d0%b3%d0%be-%d0%ba%d0%b8/#3)
    1.  [Установка](https://iamninja.ru/2023/08/16/%d0%bc%d0%b5%d1%82%d0%be%d0%b4%d1%8b-%d0%be%d0%b1%d1%85%d0%be%d0%b4%d0%b0-%d0%b1%d0%bb%d0%be%d0%ba%d0%b8%d1%80%d0%be%d0%b2%d0%be%d0%ba-%d0%b2%d0%b5%d0%bb%d0%b8%d0%ba%d0%be%d0%b3%d0%be-%d0%ba%d0%b8/#3.1)
    2.  [SSL](https://iamninja.ru/2023/08/16/%d0%bc%d0%b5%d1%82%d0%be%d0%b4%d1%8b-%d0%be%d0%b1%d1%85%d0%be%d0%b4%d0%b0-%d0%b1%d0%bb%d0%be%d0%ba%d0%b8%d1%80%d0%be%d0%b2%d0%be%d0%ba-%d0%b2%d0%b5%d0%bb%d0%b8%d0%ba%d0%be%d0%b3%d0%be-%d0%ba%d0%b8/#3.2)
    3.  [Firewall](https://iamninja.ru/2023/08/16/%d0%bc%d0%b5%d1%82%d0%be%d0%b4%d1%8b-%d0%be%d0%b1%d1%85%d0%be%d0%b4%d0%b0-%d0%b1%d0%bb%d0%be%d0%ba%d0%b8%d1%80%d0%be%d0%b2%d0%be%d0%ba-%d0%b2%d0%b5%d0%bb%d0%b8%d0%ba%d0%be%d0%b3%d0%be-%d0%ba%d0%b8/#3.3)
    4.  [WEB](https://iamninja.ru/2023/08/16/%d0%bc%d0%b5%d1%82%d0%be%d0%b4%d1%8b-%d0%be%d0%b1%d1%85%d0%be%d0%b4%d0%b0-%d0%b1%d0%bb%d0%be%d0%ba%d0%b8%d1%80%d0%be%d0%b2%d0%be%d0%ba-%d0%b2%d0%b5%d0%bb%d0%b8%d0%ba%d0%be%d0%b3%d0%be-%d0%ba%d0%b8/#3.4)
    5.  [Настройка клиента Windows](https://iamninja.ru/2023/08/16/%d0%bc%d0%b5%d1%82%d0%be%d0%b4%d1%8b-%d0%be%d0%b1%d1%85%d0%be%d0%b4%d0%b0-%d0%b1%d0%bb%d0%be%d0%ba%d0%b8%d1%80%d0%be%d0%b2%d0%be%d0%ba-%d0%b2%d0%b5%d0%bb%d0%b8%d0%ba%d0%be%d0%b3%d0%be-%d0%ba%d0%b8/#3.5)
    6.  [Настройка клиента Android](https://iamninja.ru/2023/08/16/%d0%bc%d0%b5%d1%82%d0%be%d0%b4%d1%8b-%d0%be%d0%b1%d1%85%d0%be%d0%b4%d0%b0-%d0%b1%d0%bb%d0%be%d0%ba%d0%b8%d1%80%d0%be%d0%b2%d0%be%d0%ba-%d0%b2%d0%b5%d0%bb%d0%b8%d0%ba%d0%be%d0%b3%d0%be-%d0%ba%d0%b8/#3.6)
4.  [Проверяем теорию практикой!](https://iamninja.ru/2023/08/16/%d0%bc%d0%b5%d1%82%d0%be%d0%b4%d1%8b-%d0%be%d0%b1%d1%85%d0%be%d0%b4%d0%b0-%d0%b1%d0%bb%d0%be%d0%ba%d0%b8%d1%80%d0%be%d0%b2%d0%be%d0%ba-%d0%b2%d0%b5%d0%bb%d0%b8%d0%ba%d0%be%d0%b3%d0%be-%d0%ba%d0%b8/#4)

<!-- truncate -->

## 1\. Теория

Современные методы интернет-цензуры и методы её обхода, это бесконечная гонка вооружений, мне данная
тема интересна в разрезе применяемых технологический решений, дизайне протоколов и связки всего
этого в единое целое, законченное решение, которое естественно устареет через короткий промежуток
времени.

**DISCLAIMER ВНИМАНИЕ**: Данный материал размещён исключительно в целях исследования современных
протоколов и их реализаций. Материал актуален на момент написания, проверяйте и пере проверяйте
работу указанных в статье протоколов на момент прочтения.

28 апреля 2023 года группа исследователей интернет-цензуры, которая делает основной упор своей
работы на исследование GFW (великого китайского файрвола), опубликовала
[большой материал](https://gfw.report/publications/usenixsecurity23/en/) о проделанном анализе
работы GFW. В статье был проведён анализ трафика и применены различные тесты, всё для того что бы
лучше понимать как в 2023 году работает GFW, который по сути своей для исследователей является
чёрным ящиком. Из данного материала мы знаем что GFW умеет динамически, читай «на лету», выявлять и
блокировать полностью зашифрованный трафик, применяя целый арсенал технический решений:
[active probing](https://ensa.fi/active-probing/), TLS fingerprint, выявлять тунели TLS-inside-TLS и
т.д. и т.п. в том числе механизмы нам не известные. Исходя из полученных данных сообщество
продолжило совершенствовать свой «арсенал».

## 2\. Технологический стек

На верхушке айсберга у нас находится xray.

**Xray** **core** — это некое приложение, в упрощённом понимании это реализация proxy сервера.
Архитектура Xray:

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/framework.fb23d2b0.png?resize=900%2C688&ssl=1)

Итак, ядро разделено на три уровня: прикладной уровень, прокси-уровень и транспортный уровень.
Каждый слой содержит несколько модулей, которые не зависят друг от друга. Модули одного типа могут
быть легко заменены.

**Прикладной уровень** содержит некоторые часто используемые функции в прокси-уровнях, которые
абстрагируются для повторного использования в разных прокси-модулях. Модули на прикладном уровне
должны быть реализованы исключительно в программном обеспечении и не должны зависеть от аппаратных
средств или технологий, связанных с платформой.

Список модулей прикладного уровня:

- Диспетчер: используется для передачи данных, полученных входящим агентом, исходящему агенту;
- Маршрутизатор: модуль маршрутизации;
- DNS: встроенный модуль DNS-сервера;
- Менеджер прокси;

**Прокси-слой**

Уровень прокси разделен на две части: входящий прокси и исходящий прокси. Эти две части независимы
друг от друга, где входящий прокси-сервер не зависит от конкретного исходящего прокси-сервера, и
наоборот.

**Транспортный уровень**

Транспортный уровень предоставляет набор инструментов и модулей, связанных с передачей данных по
сети.

**VLESS**

Итак у нас есть некий proxy, теперь стоит задача передать данные между клиентом и сервером. Для этой
задачи был разработан протокол передачи данных
[VLESS](https://xtls.github.io/Xray-docs-next/en/development/protocols/vless.html#vless-protocol).
Это легковесный протокол передачи данных без сохранения состояния, который можно использовать в
качестве моста между клиентами и серверами Xray. Наш протокол передачи данных, выполняет несколько
важных ролей: идентифицирует клиентов (свой-чужой), согласовывает метод шифрования между клиентом и
сервером, так как сам протокол ничего не шифрует, обфускация трафика, а так же согласовывает прочие
протоколы и фичи которые будут применяться в ходе сессии передачи данных.

**«Прочие протоколы и фичи»**

Будем считать что для передачи данных наш транспортный протокол согласовал следующие параметры:

**uTLS** — необходим для обхода механизма детектирования
[TLS fingerprint](https://tlsfingerprint.io/). Крайне важный пункт, на данный момент рекомендуется к
применению на всех клиентах.

**XTLS** — фирменная фича Xray, позволяет шифровать передаваемые данные, устойчив к выявлению тунеля
TLS-inside-TLS (так как по сути не использует его). Имеет несколько версий которые отличаются
алгоритмами работы.

**XTLS-Reality** — на данный момент, новейшее супер оружие в методах обхода цензуры. Сообщается о
том GFW ещё не научился с лёгкостью его выявлять.

## 3\. Реализация

Итак, мы разобрали немного теории, пробежались по верхам применяемого технологического стека,
перейдём к практическим занятиям. Попробуем реализовать всю описанную нами цепочку и посмотрим
результат. Делать всё будем на арендованном VPS (здесь могла быть ваша реклама). Так как лень
двигатель прогресса, за основу возьмём готовый проект — [x-ui](https://github.com/alireza0/x-ui).
Проект не уникальный в своём роде и имеет собратьев разной степени функционала и завершенности.

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/x-ui.png?resize=900%2C714&ssl=1)

Главная страница проекта встречает нас впечатляющим перечнем фич, а так же предупреждением: Проект
предназначен только для обучения и общения, не предназначен для совершения запрещённых действий, а
так же просят не использовать в production, в боевой среде значит.

**Установка**

Она не прилично простая:

```
# bash <(curl -Ls https://raw.githubusercontent.com/alireza0/x-ui/master/install.sh)
```

Скачается и запустится скрипт. Нам зададут 4 вопроса.

1\. вы уверены (y/n);

2\. имя админа;

3\. пароль;

4\. нужно указать порт на котором веб интерфейс админ панели будет слушать.

**SSL**

Далее получим SSL сертификат от [Let’s Encrypt](https://letsencrypt.org/):

```
# certbot certonly --standalone --register-unsafely-without-email --non-interactive --agree-tos -d <Your Domain Name>
```

**Firewall**

Настроим firewall, нам понадобится пробросить порт к панели управления, порт мы указывали на этапе
установки в 4 пункте и любой порт для работы самого прокси:

```
# ufw allow 8443/tcp comment 'xray+VLESS+xtls+reality'
# ufw allow 47777/tcp comment 'x-ui web'
# ufw status verbose
```

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/x-ui-web.png?resize=900%2C307&ssl=1)

**WEB**

Можно приступить к настройке на стороне сервера.

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/x-ui-web1.png?resize=900%2C296&ssl=1)

Первым делом, идём в настройки панели:

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/x-ui-web2.png?resize=900%2C648&ssl=1)

Заполняем параметры: имя домена, порт панели, путь до публичного и приватного ключа сертифката и
временную зону. После этих настроек, панель станет доступна по https. Прочие параметры рассматривать
не будем, там ничего интересного, телеграмм бот настраивается элементарно и процесс хорошо описан
как в самой панели так и в документации.

Далее идём в раздел пользователи, создаём нашего пользователя:

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/x-ui-web-user.png?resize=479%2C1024&ssl=1)

А тут уже интересно, здесь указываем: протокол — VLESS, порт — куда будет подключаться клиент,
ставим галку — Reality, домен, обязательно указываем uTLS, сайт под который будет маскироваться наш
proxy для не авторизованных клиентов, нажимаем кнопку — Get new cert, после этого сгенерируются
новый ключи. Дальше настраиваем пользователя в выпадающем меню.

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/x-ui-web-user2.png?resize=591%2C473&ssl=1)

Здесь есть различные опии не нуждающиеся в пояснении, нам важно выбрать Flow как на картинке, важно,
опция станет доступна только после включения — Reality на предыдущем шаге. На этом всё. У нас
настроена работа прокси в режиме: xray+VLESS+xtls+reality. Можем генерировать QR код для клиента и
приступать к настройке. Ниже скриншот с учётными записями моих клиентов. Для каждого можно увидеть
QR код или же просто посмотреть подробную информацию.

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/x-ui-web-user3.png?resize=900%2C367&ssl=1)

**Настройка клиента Windows**

Идём по [ссылке](https://github.com/MatsuriDayo/nekoray/releases) качаем последний релиз NekoBox.
Распаковываем и запускаем. Выбираем ядро — **sing-box**. Сканируем QR код из нашей панели, программа
умеет считывать код прямо с экрана, правда пришлось сначала сделать скриншот QR кода, иначе NekoBox
не смог его считать.

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/neko-box-1.png?resize=900%2C705&ssl=1)

Профиль клиента импортируется, на всякий случай можно открыть полученный профиль и убедится что все
настройки подхватились, обязательно смотрим строчку fingerprint.

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/neko-box-2.png?resize=900%2C608&ssl=1)

Теперь нужно настроить маршрутизацию нашего proxy. Идея в том что бы сайты из Российского сегмента
сети пускать напрямую, всё остальное через proxy. Для этого будем использовать базу GeoIP из
NekoBox. Идём в Настройки — Настройка Маршрутов, Режим подслушивания — Подслушивать для
маршрутизации. Далее вкладка DNS:

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/neko-box-4.png?resize=900%2C697&ssl=1)

Указываем DNS-over-HTTPS, можно указать https://8.8.8.8/dns-query. Включаем DNS-маршрутизацию.

Далее вкладка — Базовые маршруты:

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/neko-box-5.png?resize=900%2C710&ssl=1)

Прописываем: geoip:ru и geoip:private. Далее — Кастомные маршруты.

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/neko-box-6.png?resize=900%2C608&ssl=1)

Приводим содержимое к приведённому виду:

```
{
    "rules": [
        {
            "domain_suffix": [
                ".ru"
            ],
            "outbound": "direct"
        }
    ]
}
```

На этом настройка маршрутизации закончена.

Остаётся запустить профиль, двойным кликом или пкм-запустить. С этого момента у нас в системе
работает SOCKS5 proxy — 127.0.0.1 на порту 2080. Можно пускать через него приложения и нужный
трафик, согласно правилам маршрутизации, пойдёт по нашей цепочке xray+VLESS+xtls+reality до сервера.
Я использую расширение [foxyproxy](https://github.com/foxyproxy/firefox-extension) для Firefox, там
всё просто, указываешь proxy и включаешь его в самом расширении, в итоге трафик Firefox будет идти
через него, не затрагивая настройки системного proxy.

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/foxy-proxy.png?resize=900%2C233&ssl=1)

**Настройка клиента Android**

Идём по [ссылке](https://4pda.to/forum/index.php?showtopic=1065786) качаем последний релиз NekoBox.
Сканируем QR код из нашей панели. Профиль импортировался, теперь так же необходимо настроить
**правила маршрутизации**:

Инструкцию и скриншоты предоставил пользователь форума
[4PDA](https://4pda.to/forum/index.php?showtopic=1065786&st=620#entry124308793) — можно пройти по
ссылке и поблагодарить человека.

В настройках nekobox проверить, что «Сервисный режим» — ‘VPN’, «Включить анализ трафика» — ‘Sniff
result for routing’.

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/1.1-1.jpg?resize=522%2C1024&ssl=1)

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/1.2.jpg?resize=523%2C1024&ssl=1)

В настройках маршрутов добавить 2 правила обхода:

- для доменов:

```
domain:ru
```

- для ip:

```
geoip:ru
```

Проверить, что эти правила (а также другие, которые вам необходимы, например для блокировки рекламы)
включены.

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/2.1.jpg?resize=522%2C1024&ssl=1)

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/2.2.jpg?resize=523%2C1024&ssl=1)

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/2.3.jpg?resize=521%2C1024&ssl=1)

В списке конфигов нажать на нужном конфиге кнопку ‘Поделиться’, в выпадающем меню выбрать пункт
‘Конфигурация’, затем ‘Экспорт в буфер обмена’.

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/3.jpg?resize=517%2C1024&ssl=1)

Далее в списке конфигов ‘Добавить профиль’ → ‘Ручные настройки’ → ‘Пользовательская конфигурация’.

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/4.1.jpg?resize=523%2C1024&ssl=1)

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/4.2.jpg?resize=521%2C1024&ssl=1)

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/4.3.jpg?resize=523%2C1024&ssl=1)

Указать имя профиля, а в пункт ‘Пользовательская конфигурация’ вставить содержимое буфера обмена.
Сохранить.

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/5.1.jpg?resize=522%2C1024&ssl=1)

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/5.2.jpg?resize=524%2C1024&ssl=1)

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/5.3.jpg?resize=522%2C1024&ssl=1)

Созданный конфиг появится в списке (вместо названия протокола будет подпись «sing-box config»).

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/5.4.jpg?resize=521%2C1024&ssl=1)

Вернуться в настройки маршрутов и отключить (или удалить) созданные правила обхода.

![](https://i0.wp.com/iamninja.ru/wp-content/uploads/2023/08/6.1.jpg?resize=520%2C1024&ssl=1)

Вуаля. Созданный кастомный конфиг будет проксировать всё, кроме ru, игнорируя глобальные правила
маршрутизации.

## 4\. Проверяем теорию практикой!

Теория разобрана! Технологический стек изучен! Всё реализованно! Как проверить что всё работает?

Во первых самая простая проверка. Открываем Firefox — [2ip.ru](https://2ip.ru/). Адрес должен
определится ваш, Российский, с указанием Российского провайдера и так далее. Открываем —
[https://whatismyipaddress.com/](https://whatismyipaddress.com/). Должен определится IP адрес вашего
VPS с развёрнутым proxy — Xray. Далее можно пробежаться по сайтам брендов, прекративших свою
деятельность в России, как пример — [https://www.dell.com/en-us](https://www.dell.com/en-us). При
правильных настройках, сайт должен открыться.

Ну и для полного успокоения можно попробовать ловить трафик снифером, например Wireshark, в нём
будет видно что запросы к иностранным сайтам не «летят», зато «летит» общение с вашим VPS по
протоколу TLS.
